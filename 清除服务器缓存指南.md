# 清除服务器缓存指南

## 问题说明

当用户异常断开连接（如直接关闭浏览器、网络中断等）时，服务器可能无法及时检测到断开事件，导致房间成员列表中残留无效连接。这会导致：
- 服务器显示有用户在线，但实际用户已断开
- 新用户无法加入房间（因为显示房间已满）
- 房间状态不准确

## 解决方案

### 1. 自动清理机制

服务器已实现自动清理机制：
- **定期清理**：每30秒自动检查并清理无效连接
- **连接检测**：在用户加入时检查并移除重复连接

### 2. 手动清理方法

#### 方法一：通过HTTP API清理（推荐）

服务器提供了以下HTTP接口：

**查看所有房间信息：**
```bash
curl http://localhost:3333/api/rooms
```

**清理无效连接（保留有效连接）：**
```bash
curl -X POST http://localhost:3333/api/rooms/cleanup
```

**清空所有房间（完全清除）：**
```bash
curl -X POST http://localhost:3333/api/rooms/clear
```

#### 方法二：重启服务器

重启Node.js服务器会清空所有内存中的房间数据：

```bash
# 停止服务器（Ctrl+C）
# 然后重新启动
cd SignTalk_System/signtalk_web/signtalk/fronted/server
node main.js
```

#### 方法三：通过浏览器访问API

如果服务器配置了反向代理，可以通过浏览器访问：

1. **查看房间信息**：
   ```
   http://your-domain:3333/api/rooms
   ```

2. **清理无效连接**：
   使用Postman或curl发送POST请求到：
   ```
   http://your-domain:3333/api/rooms/cleanup
   ```

3. **清空所有房间**：
   使用Postman或curl发送POST请求到：
   ```
   http://your-domain:3333/api/rooms/clear
   ```

## API接口说明

### GET /api/rooms

获取所有房间的当前状态。

**响应示例：**
```json
{
  "success": true,
  "rooms": {
    "666": [
      {
        "username": "lfy",
        "userId": "15KfNDUnRJl9pI_EAAAC"
      }
    ]
  },
  "totalRooms": 1,
  "timestamp": "2025-11-06T09:33:21.349Z"
}
```

### POST /api/rooms/cleanup

清理所有无效连接（保留有效连接）。

**响应示例：**
```json
{
  "success": true,
  "cleanedCount": 2,
  "message": "已清理 2 个无效连接",
  "timestamp": "2025-11-06T09:33:21.349Z"
}
```

### POST /api/rooms/clear

清空所有房间数据（完全清除）。

**响应示例：**
```json
{
  "success": true,
  "message": "所有房间已清空",
  "timestamp": "2025-11-06T09:33:21.349Z"
}
```

## 预防措施

1. **正常退出**：用户应该通过"离开"按钮正常退出房间，而不是直接关闭浏览器
2. **定期清理**：服务器每30秒自动清理一次无效连接
3. **监控日志**：查看服务器日志，关注"清理无效连接"的日志信息

## 常见问题

### Q: 为什么会有无效连接？

A: 当用户直接关闭浏览器、网络中断或浏览器崩溃时，可能无法正常触发断开连接事件，导致服务器无法及时清理。

### Q: 自动清理会影响正常用户吗？

A: 不会。自动清理只会移除已经断开的连接，不会影响正在正常连接的用户。

### Q: 如何确认清理是否成功？

A: 调用 `GET /api/rooms` 接口查看清理后的房间状态，或查看服务器日志中的清理信息。

## 注意事项

- 清空所有房间（`/api/rooms/clear`）会移除所有房间数据，包括正常连接的用户
- 建议优先使用 `/api/rooms/cleanup` 来清理无效连接
- 如果问题持续存在，考虑重启服务器

